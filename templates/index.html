<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Collaborative IDE</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>Live Collaborative IDE</h1>
  <canvas id="drawingCanvas"></canvas>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById("drawingCanvas");
    const ctx = canvas.getContext("2d");

    const userId = Math.random().toString(36).substr(2, 9); // Unique ID for each user
    const state = { drawing: false, cursorX: 0, cursorY: 0 };

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Resize canvas on window resize
    window.addEventListener("resize", () => {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      ctx.putImageData(imageData, 0, 0);
    });

    // Mouse events for drawing
    canvas.addEventListener("mousedown", e => {
      state.drawing = true;
      state.cursorX = e.offsetX;
      state.cursorY = e.offsetY;
    });

    canvas.addEventListener("mouseup", () => {
      state.drawing = false;
    });

    canvas.addEventListener("mousemove", e => {
      if (state.drawing) {
        const x = e.offsetX;
        const y = e.offsetY;
        const data = { fromX: state.cursorX, fromY: state.cursorY, toX: x, toY: y, color: "black" };
        socket.emit("update-drawing", data);
        draw(data);
        state.cursorX = x;
        state.cursorY = y;
      }
      // Emit cursor position
      socket.emit("update-cursor", { id: userId, x: e.offsetX, y: e.offsetY });
    });

    // Draw function
    function draw({ fromX, fromY, toX, toY, color }) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(fromX, fromY);
      ctx.lineTo(toX, toY);
      ctx.stroke();
    }

    // Handle incoming drawing updates
    socket.on("update-drawing", data => {
      draw(data);
    });

    // Handle incoming cursor updates
    socket.on("update-cursor", data => {
      const cursor = document.getElementById(`cursor-${data.id}`) || createCursor(data.id);
      cursor.style.left = `${data.x}px`;
      cursor.style.top = `${data.y}px`;
    });

    // Handle initial canvas state
    socket.on("init-canvas", canvasState => {
      canvasState.elements.forEach(draw);
    });

    // Create cursor element
    function createCursor(id) {
      const cursor = document.createElement("div");
      cursor.id = `cursor-${id}`;
      cursor.className = "cursor";
      document.body.appendChild(cursor);
      return cursor;
    }
  </script>
</body>
</html>
